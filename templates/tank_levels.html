<!DOCTYPE html>
<html>
<head>
    <title>Tank Levels</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav>
    <a href="/">Dashboard</a>
    <a href="/transactions">Transactions</a>
    <a href="/tanklevels">Tank Levels</a>
</nav>

    <h1>Tank Levels</h1>

    <!-- Date Range Filter Form -->
    <form method="get" action="/tanklevels">
        <label for="start">Start Date:</label>
        <input type="date" id="start" name="start">
        <label for="end">End Date:</label>
        <input type="date" id="end" name="end">
        <button type="submit">Filter</button>
    </form>

    <br>

    <!-- Chart Container -->
    <canvas id="levelChart" height="100"></canvas>
    <br>

    <!-- Data Table -->
    <table id="tankTable" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                {% for header in headers %}
                    <th>{{ header }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
                <tr>
                    {% for item in row %}
                        <td>{{ item }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        $(document).ready(function() {
            const headers = {{ headers | tojson }};
            const rows = {{ rows | tojson }};

            // Extract the indexes
            const timestampIndex = headers.indexOf("Reading Timestamp");
            const volumeIndex = headers.indexOf("Volume");

            const labels = rows.map(row => row[timestampIndex]);
            const data = rows.map(row => row[volumeIndex]);

            const ctx = document.getElementById('levelChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.reverse(), // Show oldest first
                    datasets: [{
                        label: 'Tank Volume',
                        data: data.reverse(),
                        borderColor: 'rgb(75, 192, 192)',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Reading Timestamp'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Volume'
                            }
                        }
                    }
                }
            });

            // Setup DataTable
            $('#tankTable').DataTable({
                dom: 'Bfrtip',
                buttons: ['copyHtml5', 'excelHtml5', 'csvHtml5'],
                scrollX: true
            });
        });
    </script>
</body>
</html>