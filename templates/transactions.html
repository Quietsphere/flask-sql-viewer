<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Transactions</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/colvis/1.3.1/css/buttons.dataTables.min.css" />

    <!-- Select2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />

    <style>
        .filter-select {
            width: 200px;
            margin-right: 1em;
            margin-bottom: 1em;
        }
        .filter-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
        }
        .dataTables_filter {
            float: none !important;
            text-align: left !important;
        }
    </style>
</head>
<body>
<nav>
    <a href="/">Dashboard</a>
    <a href="/transactions">Transactions</a>
    <a href="/tanklevels">Tank Levels</a>
</nav>

<div class="container">
    <h1>Transactions</h1>
    <h2>Showing data for {{ date_range }}</h2>

    {% set active_filters = [] %}
    {% for col in ['StationID', 'TransactionType', 'DriverName', 'CompanyName', 'TruckID', 'Product', 'TankID'] %}
        {% set selected = request.args.getlist(col) %}
        {% if selected %}
            {% set label = col.replace('ID', '') %}
            {% set values = selected | join(', ') %}
            {% set _ = active_filters.append(label ~ ': ' ~ values) %}
        {% endif %}
    {% endfor %}
    {% if active_filters %}
        <p><strong>Active Filters:</strong> {{ active_filters | join(' | ') }}</p>
    {% endif %}

    <!-- Month Navigation -->
    <div>
        <a href="{{ url_for('transactions', month_offset=month_offset - 1) }}">&laquo; Previous Month</a>
        <a href="{{ url_for('transactions', month_offset=0) }}">Current Month</a>
        <a href="{{ url_for('transactions', month_offset=month_offset + 1) }}">Next Month &raquo;</a>
    </div>
    <br>

    <details open>
        <summary><strong>Filter Options</strong></summary>
        <form method="get" class="filter-form">
            {% if not request.args %}
                <input type="hidden" name="month_offset" value="{{ month_offset }}"/>
            {% endif %}

            <div class="filter-grid">
                <div>
                    <label for="start_date">Start Date:</label>
                    <input type="date" id="start_date" name="start_date" value="{{ request.args.get('start_date', '') }}">
                </div>
                <div>
                    <label for="end_date">End Date:</label>
                    <input type="date" id="end_date" name="end_date" value="{{ request.args.get('end_date', '') }}">
                </div>

                {% for col in ['StationID', 'TransactionType', 'DriverName', 'CompanyName', 'TruckID', 'Product', 'TankID'] %}
                    <div>
                        <label for="{{ col }}">{{ col }}:</label>
                        <select id="{{ col }}" name="{{ col }}" multiple="multiple" class="filter-select">
                            <option></option>
                            {% for option in filters[col] %}
                                <option value="{{ option }}"
                                    {% if option in request.args.getlist(col) %}selected{% endif %}>
                                    {{ option }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                {% endfor %}
            </div>

            <br>
            <button type="submit">Filter</button>
            <a href="{{ url_for('transactions') }}">Reset Filters</a>
        </form>
    </details>

    <br>

    <table id="transactions-table" class="display nowrap" style="width:100%">
        <thead>
        <tr>
            {% for header in headers %}
                <th>{{ header }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in rows %}
            <tr>
                {% for value in row %}
                    <td>{{ value }}</td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
<div id="volume-total" style="margin-top: 1em; font-weight: bold;">
    Total Volume Delivered: <span id="total-volume">Calculating...</span>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

<!-- JSZip & pdfmake for exporting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function () {
        $('.filter-select').select2({
            placeholder: 'Select options',
            allowClear: true,
            width: 'resolve'
        });

        $('.filter-select, #start_date, #end_date').on('change', function () {
            $('.filter-form').submit();
        });

        const getExportFilename = () => {
            const start = $('#start_date').val();
            const end = $('#end_date').val();
            if (start && end) {
                return `transactions_${start}_to_${end}`;
            } else {
                return "transactions_all_data";
            }
        };

        const table = $('#transactions-table').DataTable({
            dom: 'Bfrtip',
            buttons: [
                'colvis',
                {
                    extend: 'copyHtml5',
                    title: null,
                    filename: getExportFilename
                },
                {
                    extend: 'csvHtml5',
                    title: null,
                    filename: getExportFilename
                },
                {
                    extend: 'excelHtml5',
                    title: null,
                    filename: getExportFilename
                },
                {
                    extend: 'pdfHtml5',
                    title: getExportFilename(),
                    filename: getExportFilename
                },
                {
                    extend: 'print',
                    title: getExportFilename()
                }
            ],
            paging: true,
            pageLength: 25,
            lengthMenu: [10, 25, 50, 100],
            scrollX: true,
            stateSave: true,
            drawCallback: function () {
                updateTotalVolume();
            }
        });

        function updateTotalVolume() {
            const volumeIndex = $('#transactions-table thead th').toArray().findIndex(th =>
                $(th).text().trim().toLowerCase() === 'volumedelivered'
            );
            let total = 0;
            if (volumeIndex !== -1) {
                table.rows({ filter: 'applied' }).every(function () {
                    const data = this.data();
                    const val = parseFloat(data[volumeIndex].toString().replace(/[^\d.-]/g, '')) || 0;
                    total += val;
                });
            }
            $('#total-volume').text(total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' gal');
        }

        updateTotalVolume();
    });
</script>

</body>
</html>
